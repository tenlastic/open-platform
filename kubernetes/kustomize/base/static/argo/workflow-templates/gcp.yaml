apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: gcp
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: tenlastic.com/low-priority
                operator: Exists
    podAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 1
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: workflows.argoproj.io/workflow
                  operator: In
                  values:
                    - "{{workflow.name}}"
            topologyKey: kubernetes.io/hostname
  arguments:
    parameters:
      - name: repo
        value: git@github.com:tenlastic/open-platform.git
      - name: revision
  entrypoint: entrypoint
  podGC:
    strategy: OnWorkflowSuccess
  serviceAccountName: argo-workflow
  ttlStrategy:
    secondsAfterSuccess: 86400
  volumeClaimTemplates:
    - metadata:
        name: workspace
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi
        storageClassName: balanced-expandable
  volumes:
    - name: cd-ssh-keys
      secret:
        secretName: cd-ssh-keys
        defaultMode: 0600
  templates:
    - name: entrypoint
      inputs:
        parameters:
          - name: repo
          - name: revision
      parallelism: 2
      steps:
        - - name: checkout
            template: checkout
            arguments:
              parameters:
                - name: repo
                  value: "{{inputs.parameters.repo}}"
                - name: revision
                  value: "{{inputs.parameters.revision}}"
        - - name: get-branch
            template: get-branch
            arguments:
              parameters:
                - name: revision
                  value: "{{inputs.parameters.revision}}"
          - name: skip
            template: skip
        - - name: gcp
            when: "'{{steps.skip.outputs.result}}' == 'false'"
            template: gcp
            arguments:
              parameters:
                - name: branch
                  value: "{{steps.get-branch.outputs.result}}"

    - name: gcp
      inputs:
        parameters:
          - name: branch
      steps:
        - - name: terraform
            when: "'{{inputs.parameters.branch}}' == 'origin/master'"
            template: terraform

    - name: checkout
      script:
        image: alpine/git:latest
        command: [sh]
        source: |
          # Add Host Key for Github.
          mkdir -p /root/.ssh/
          ssh-keyscan -t rsa github.com > /root/.ssh/known_hosts
          cp /tmp/secrets/cd-ssh-keys/id_rsa /root/.ssh/id_rsa

          # Use SSH instead of HTTPS.
          git config --global url."ssh://git@github.com".insteadOf "https://github.com" || true
          git config --global gc.auto 0 || true

          # Clone repository and reset to specific revision.
          git clone {{inputs.parameters.repo}} /workspace/open-platform/
          cd /workspace/open-platform/
          git fetch --all
          git reset --hard {{inputs.parameters.revision}}
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - name: cd-ssh-keys
            mountPath: /tmp/secrets/cd-ssh-keys/
            readonly: true
          - name: workspace
            mountPath: /workspace/
      inputs:
        parameters:
          - name: repo
          - name: revision

    - name: get-branch
      script:
        image: alpine/git:latest
        command: [sh]
        source: git branch --contains {{inputs.parameters.revision}} --remotes | tail +2 | cut -c 3-
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - name: workspace
            mountPath: /workspace/
        workingDir: /workspace/open-platform/
      inputs:
        parameters:
          - name: revision

    - name: skip
      script:
        image: alpine/git:latest
        command: [sh]
        source: |
          case $(git log -1 --pretty=%B) in 
            *\[skip\ ci\]*) echo "true" ;;
            *) echo "false";; 
          esac
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - name: workspace
            mountPath: /workspace/
        workingDir: /workspace/open-platform/

    - name: terraform
      container:
        image: hashicorp/terraform:0.14.5
        command: [sh]
        args:
          - /workspace/open-platform/ci-cd/terraform.sh
        envFrom:
          - secretRef:
              name: cd-environment-variables
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - name: workspace
            mountPath: /workspace/
        workingDir: /workspace/open-platform/gcp/terraform/
