apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: sandbox-role
rules:
  - apiGroups:
      - apps
    resources:
      - deployments
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
  - apiGroups:
      - ""
    resources:
      - services
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: sandbox
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: sandbox-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: sandbox-role
subjects:
  - kind: ServiceAccount
    name: sandbox
---
apiVersion: v1
kind: Pod
metadata:
  name: sandbox
  labels:
    app: sandbox
spec:
  containers:
    - name: sandbox
      image: node:10
      command:
        - /bin/bash
        - -c
        - --
        - while true; do sleep 30; done;
      ports:
        - containerPort: 3000
      volumeMounts:
        - name: app
          mountPath: /usr/src/app/
      workingDir: /usr/src/app/
    - name: dind
      image: docker:19.03.8-dind
      command:
        - "dockerd"
        - "--host"
        - "tcp://0.0.0.0:2375"
        - "--insecure-registry"
        - "docker-registry:5000"
      securityContext:
        privileged: true
    - name: docker-registry
      image: registry:latest
      command:
        - /bin/sh
        - -c
        - trap "exit 0" SIGKILL && ./entrypoint.sh /etc/docker/registry/config.yml
    - name: kafka
      image: spotify/kafka:latest
      env:
        - name: ADVERTISED_HOST
          value: localhost
        - name: ADVERTISED_PORT
          value: "9092"
    - name: mongo
      image: tenlastic/mongo-replica-set:latest
      env:
        - name: REPLICA_SET_HOSTNAME
          value: localhost
    - name: minio
      image: minio/minio:latest
      command:
        - minio
        - server
        - /data
    - name: rabbitmq
      image: rabbitmq
  serviceAccountName: sandbox
  volumes:
    - name: app
      hostPath:
        path: /c/open-platform/
---
apiVersion: v1
kind: Service
metadata:
  name: sandbox
  labels:
    app: sandbox
    service: sandbox
spec:
  ports:
    - port: 3000
      name: http
  selector:
    app: sandbox
