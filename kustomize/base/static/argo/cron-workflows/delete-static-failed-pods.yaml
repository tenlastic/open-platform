apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: delete-static-failed-pods
  namespace: static
rules:
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - delete
      - get
      - list
      - watch
      - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: delete-static-failed-pods
  namespace: static
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: delete-static-failed-pods
subjects:
  - kind: ServiceAccount
    name: delete-static-failed-pods
    namespace: static
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: delete-static-failed-pods
  namespace: static
---
apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: delete-static-failed-pods
  namespace: static
spec:
  concurrencyPolicy: Allow
  schedule: "*/5 * * * *"
  startingDeadlineSeconds: 0
  timezone: America/New_York
  workflowSpec:
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: tenlastic.com/low-priority
                  operator: Exists
    entrypoint: delete-static-failed-pods
    podGC:
      strategy: OnWorkflowCompletion
    serviceAccountName: delete-static-failed-pods
    ttlStrategy:
      secondsAfterSuccess: 60
    templates:
      - name: delete-static-failed-pods
        script:
          command: [sh]
          image: bitnami/kubectl:latest
          imagePullPolicy: IfNotPresent
          resources:
            limits:
              cpu: 100m
              memory: 50M
            requests:
              cpu: 25m
              memory: 50M
          source: |
            COMMAND="kubectl get pods -n static -o name --field-selector status.phase=Failed"
            if [ "$($COMMAND | wc -l)" -gt 0 ]; then
              $COMMAND | xargs kubectl delete -n static
            fi
